<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ranking â€” VotaÃ§Ã£o Natalina Torre 4</title>
  <link rel="icon" type="image/png" href="https://api.iconify.design/emojione/christmas-tree.svg">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#059669">
  <link rel="apple-touch-icon" href="https://api.iconify.design/noto/christmas-tree.svg?width=180&height=180">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .twinkle { box-shadow: 0 0 0 2px rgba(255,255,255,.1), 0 0 24px rgba(16,185,129,.25) inset; }
  </style>
</head>
<body class="bg-gradient-to-b from-emerald-50 via-white to-red-50 min-h-screen relative overflow-x-hidden">

  <canvas id="snow" class="pointer-events-none fixed inset-0 -z-10"></canvas>
  <audio id="bgMusic" src="./assets/jingle-bells.wav" loop preload="auto"></audio>

  <header class="bg-gradient-to-r from-emerald-700 via-emerald-600 to-red-700 text-white twinkle">
    <div class="max-w-4xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center gap-3 justify-between">
      <h1 class="text-xl font-bold">ğŸ† Ranking â€” VotaÃ§Ã£o de Natal</h1>
      <div class="flex items-center gap-2 flex-wrap justify-center">
        <button id="snowToggle" class="px-3 py-2 bg-white/20 hover:bg-white/30 border border-white/40 rounded-lg transition-all" title="Alternar neve">
          â„ï¸ <span class="hidden md:inline">Neve</span>
        </button>
        <button id="sparkleToggle" class="px-3 py-2 bg-white/20 hover:bg-white/30 border border-white/40 rounded-lg transition-all" title="Alternar brilho">
          âœ¨ <span class="hidden md:inline">Brilho</span>
        </button>
        <button id="musicToggle" class="px-3 py-2 bg-white/20 hover:bg-white/30 border border-white/40 rounded-lg transition-all" title="Alternar mÃºsica">
          ğŸ”” <span class="hidden md:inline">MÃºsica</span>
        </button>
        <span id="adminInfo" class="text-sm opacity-90 mr-1"></span>
        <button id="loginBtn" class="px-3 py-2 bg-white text-emerald-700 rounded-lg font-medium hidden">Admin Login</button>
        <button id="logoutBtn" class="px-3 py-2 bg-white/20 border border-white/40 rounded-lg hidden hover:bg-white/30 transition-all">Sair</button>
        <a href="./index.html" class="px-3 py-2 bg-white text-emerald-700 hover:bg-emerald-50 rounded-lg font-medium transition-all">Voltar</a>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
    <!-- Painel Administrativo -->
    <div id="adminPanel" class="hidden bg-white rounded-2xl shadow-lg p-6 border-2 border-emerald-600">
      <h2 class="text-xl font-bold text-emerald-700 mb-4 flex items-center gap-2">
        âš™ï¸ Painel Administrativo
      </h2>
      <div class="grid md:grid-cols-2 gap-3">
        <button id="btnIniciarVotacao" class="px-4 py-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition-all flex items-center justify-center gap-2">
          â–¶ï¸ Iniciar VotaÃ§Ã£o
        </button>
        <button id="btnEncerrarVotacao" class="px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition-all flex items-center justify-center gap-2">
          â¹ï¸ Encerrar VotaÃ§Ã£o
        </button>
        <button id="btnZerarVotos" class="px-4 py-3 rounded-lg bg-orange-600 hover:bg-orange-700 text-white font-medium transition-all flex items-center justify-center gap-2">
          ğŸ—‘ï¸ Zerar Todos os Votos
        </button>
        <button id="btnGerarPDF" class="px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all flex items-center justify-center gap-2">
          ğŸ“„ Gerar PDF do Ranking
        </button>
      </div>
      <div id="adminMsg" class="mt-3 text-sm font-medium"></div>
    </div>

    <!-- Ranking -->
    <div id="ranking" class="bg-white rounded-2xl shadow-lg p-4 divide-y"></div>
  </main>

  <footer class="relative bg-gradient-to-r from-emerald-50 via-red-50 to-emerald-50 border-t border-emerald-200 py-8">
    <!-- Corda decorativa -->
    <div class="absolute top-0 left-0 right-0 h-4 bg-gradient-to-r from-emerald-700 via-emerald-600 to-red-700 flex items-center justify-around overflow-hidden">
      <span class="text-yellow-300 text-xl animate-pulse">ğŸ„</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 0.3s;">â­</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 0.6s;">ğŸ</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 0.9s;">ğŸ””</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 1.2s;">ğŸ„</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 0.4s;">â­</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 0.7s;">ğŸ</span>
      <span class="text-yellow-300 text-xl animate-pulse" style="animation-delay: 1s;">ğŸ””</span>
    </div>
    <div class="max-w-5xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4 mt-2">
      <div class="flex flex-col items-center gap-2">
        <a href="https://natal-votacao-atual.vercel.app" target="_blank" rel="noopener noreferrer" class="block">
          <div class="bg-white p-3 rounded-lg shadow-md border-2 border-emerald-600 hover:border-emerald-500 transition-all hover:shadow-lg">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://natal-votacao-atual.vercel.app" alt="QR Code" class="w-28 h-28">
          </div>
        </a>
        <a href="https://natal-votacao-atual.vercel.app" target="_blank" rel="noopener noreferrer" class="text-xs text-emerald-700 font-medium hover:text-emerald-600 hover:underline">
          Acesse pelo celular
        </a>
      </div>
      
      <div class="text-center text-xs text-slate-600 leading-relaxed">
        <p>Â© Todos os direitos reservados 2025</p>
        <p>Desenvolvido por <span class="font-semibold text-emerald-700">JÃ©ssica Maria de Sousa</span></p>
        <p class="text-red-600 font-medium">ComissÃ£o de Natal - Torre 4</p>
      </div>
    </div>
  </footer>

  <!-- Modal de acesso administrativo -->
  <div id="accessModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-xl w-[95%] max-w-md p-6 text-center space-y-4">
      <div class="text-4xl">ğŸ”</div>
      <h3 class="text-xl font-bold text-slate-800">Ãrea Administrativa</h3>
      <p class="text-sm text-slate-600">Esta pÃ¡gina Ã© restrita aos administradores da votaÃ§Ã£o. FaÃ§a login para continuar.</p>
      <button id="adminLoginBtn" class="w-full px-4 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-medium transition-all">
        Entrar com Google
      </button>
      <a href="./index.html" class="block text-sm text-slate-500 hover:text-slate-700">Voltar para votaÃ§Ã£o</a>
    </div>
  </div>

  <script src="./js/firebase.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const accessModal = document.getElementById('accessModal');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminInfo = document.getElementById('adminInfo');
    
    // Lista de emails de administradores autorizados
    const ADMIN_EMAILS = [
      'jhessymary26@gmail.com'
    ];
    
    let isAdmin = false;
    
    function checkAdminAccess(user) {
      if (!user) {
        accessModal?.classList.remove('hidden');
        document.getElementById('ranking').innerHTML = '';
        return false;
      }
      
      isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
      
      if (!isAdmin) {
        accessModal?.classList.remove('hidden');
        document.getElementById('ranking').innerHTML = `
          <div class="p-6 text-center text-red-600">
            <p class="text-lg font-semibold">Acesso Negado</p>
            <p class="text-sm mt-2">VocÃª nÃ£o tem permissÃ£o para acessar esta pÃ¡gina.</p>
          </div>
        `;
        if (adminInfo) adminInfo.textContent = user.email;
        logoutBtn?.classList.remove('hidden');
        return false;
      }
      
      accessModal?.classList.add('hidden');
      if (adminInfo) adminInfo.textContent = `Admin: ${user.displayName || user.email}`;
      logoutBtn?.classList.remove('hidden');
      document.getElementById('adminPanel')?.classList.remove('hidden');
      return true;
    }
    
    adminLoginBtn?.addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (error) {
        console.error('Erro no login:', error);
        alert('Erro ao fazer login: ' + error.message);
      }
    });
    
    logoutBtn?.addEventListener('click', async () => {
      await auth.signOut();
      window.location.reload();
    });
    
    auth.onAuthStateChanged(user => {
      if (checkAdminAccess(user)) {
        carregarRanking();
      }
    });
    
    async function carregarRanking() {
      const rankingEl = document.getElementById('ranking');
      rankingEl.innerHTML = `<p class="text-sm text-slate-500 p-4">Carregando ranking...</p>`;
      
      try {
        const snap = await db.collection('fotos_natal').orderBy('votos', 'desc').get();
        let i = 1, html = '';
        
        snap.forEach(doc => {
          const d = doc.data();
          const medalIcon = i === 1 ? 'ğŸ¥‡' : i === 2 ? 'ğŸ¥ˆ' : i === 3 ? 'ğŸ¥‰' : '';
          html += `
            <div class="py-4 flex items-center gap-4 hover:bg-slate-50 transition-colors rounded-lg px-2">
              <div class="w-12 text-2xl font-bold ${i<=3?'text-emerald-600':'text-slate-400'} text-center">
                ${medalIcon || i + 'Âº'}
              </div>
              <img src="${d.urlFoto}" class="w-24 h-24 object-cover rounded-lg border-2 ${i<=3?'border-emerald-400':'border-slate-200'} shadow"/>
              <div class="flex-1">
                <div class="font-bold text-lg">${d.andar}Âº andar â€“ Apto ${d.apartamento}</div>
                <div class="text-sm text-slate-600 mt-1">
                  <span class="inline-flex items-center gap-1">
                    <span class="text-lg">â­</span>
                    <span class="font-semibold text-emerald-600">${d.votos || 0}</span> 
                    voto${(d.votos || 0) !== 1 ? 's' : ''}
                  </span>
                </div>
              </div>
            </div>
          `;
          i++;
        });
        
        rankingEl.innerHTML = html || `<p class="text-sm text-slate-500 p-4">Nenhuma foto enviada ainda.</p>`;
      } catch (error) {
        console.error('Erro ao carregar ranking:', error);
        rankingEl.innerHTML = `<p class="text-sm text-red-500 p-4">Erro ao carregar ranking.</p>`;
      }
    }
    
    // ===== FUNÃ‡Ã•ES ADMINISTRATIVAS =====
    const adminMsg = document.getElementById('adminMsg');
    
    function showAdminMsg(msg, isError = false) {
      if (adminMsg) {
        adminMsg.textContent = msg;
        adminMsg.className = `mt-3 text-sm font-medium ${isError ? 'text-red-600' : 'text-green-600'}`;
        setTimeout(() => adminMsg.textContent = '', 5000);
      }
    }
    
    // Iniciar VotaÃ§Ã£o
    document.getElementById('btnIniciarVotacao')?.addEventListener('click', async () => {
      if (!confirm('Deseja iniciar a votaÃ§Ã£o agora?')) return;
      try {
        const agora = firebase.firestore.Timestamp.now();
        const fimPadrao = firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)); // +30 dias
        await db.collection('settings').doc('votacao').set({
          inicio: agora,
          fim: fimPadrao
        });
        showAdminMsg('âœ… VotaÃ§Ã£o iniciada com sucesso!');
      } catch (error) {
        showAdminMsg('âŒ Erro ao iniciar votaÃ§Ã£o: ' + error.message, true);
      }
    });
    
    // Encerrar VotaÃ§Ã£o
    document.getElementById('btnEncerrarVotacao')?.addEventListener('click', async () => {
      if (!confirm('Deseja encerrar a votaÃ§Ã£o agora? Esta aÃ§Ã£o Ã© irreversÃ­vel!')) return;
      try {
        const agora = firebase.firestore.Timestamp.now();
        await db.collection('settings').doc('votacao').update({
          fim: agora
        });
        showAdminMsg('âœ… VotaÃ§Ã£o encerrada com sucesso!');
      } catch (error) {
        showAdminMsg('âŒ Erro ao encerrar votaÃ§Ã£o: ' + error.message, true);
      }
    });
    
    // Zerar Votos
    document.getElementById('btnZerarVotos')?.addEventListener('click', async () => {
      if (!confirm('âš ï¸ ATENÃ‡ÃƒO: Isso apagarÃ¡ TODOS os votos de TODAS as fotos! Deseja continuar?')) return;
      if (!confirm('Tem certeza absoluta? Esta aÃ§Ã£o NÃƒO pode ser desfeita!')) return;
      
      try {
        const fotosSnap = await db.collection('fotos_natal').get();
        const batch = db.batch();
        let count = 0;
        
        for (const doc of fotosSnap.docs) {
          // Zera votos da foto
          batch.update(doc.ref, { votos: 0 });
          
          // Deleta subcoleÃ§Ã£o de voters
          const votersSnap = await doc.ref.collection('voters').get();
          votersSnap.docs.forEach(voterDoc => {
            batch.delete(voterDoc.ref);
            count++;
          });
        }
        
        await batch.commit();
        showAdminMsg(`âœ… ${fotosSnap.size} fotos zeradas e ${count} votos removidos!`);
        await carregarRanking();
      } catch (error) {
        showAdminMsg('âŒ Erro ao zerar votos: ' + error.message, true);
      }
    });
    
    // Gerar PDF
    document.getElementById('btnGerarPDF')?.addEventListener('click', async () => {
      try {
        showAdminMsg('ğŸ“„ Gerando PDF...');
        
        const snap = await db.collection('fotos_natal').orderBy('votos', 'desc').get();
        let content = `
          <html>
          <head>
            <meta charset="utf-8">
            <title>Ranking - VotaÃ§Ã£o Natalina Torre 4</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #059669; text-align: center; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
              th { background-color: #059669; color: white; }
              tr:nth-child(even) { background-color: #f2f2f2; }
              .medal { font-size: 24px; }
            </style>
          </head>
          <body>
            <h1>ğŸ„ Ranking - VotaÃ§Ã£o Natalina Torre 4 2025</h1>
            <p style="text-align: center; color: #666;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
            <table>
              <thead>
                <tr>
                  <th>PosiÃ§Ã£o</th>
                  <th>Andar</th>
                  <th>Apartamento</th>
                  <th>Votos</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        let pos = 1;
        snap.forEach(doc => {
          const d = doc.data();
          const medal = pos === 1 ? 'ğŸ¥‡' : pos === 2 ? 'ğŸ¥ˆ' : pos === 3 ? 'ğŸ¥‰' : '';
          content += `
            <tr>
              <td class="medal">${medal} ${pos}Âº</td>
              <td>${d.andar}Âº andar</td>
              <td>${d.apartamento}</td>
              <td><strong>${d.votos || 0}</strong> voto${(d.votos || 0) !== 1 ? 's' : ''}</td>
            </tr>
          `;
          pos++;
        });
        
        content += `
              </tbody>
            </table>
            <p style="margin-top: 40px; text-align: center; color: #999; font-size: 12px;">
              Â© 2025 ComissÃ£o de Natal - Torre 4 | Desenvolvido por JÃ©ssica Maria de Sousa
            </p>
          </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(content);
        printWindow.document.close();
        printWindow.print();
        
        showAdminMsg('âœ… PDF gerado! Use Ctrl+P ou Cmd+P para salvar.');
      } catch (error) {
        showAdminMsg('âŒ Erro ao gerar PDF: ' + error.message, true);
      }
    });
  </script>
  <script src="./js/theme.js"></script>
  <script>
    // Registra Service Worker para PWA
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
